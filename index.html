<!DOCTYPE html><html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>XMOD Chat ‚Äì Full-screen + Theme Toggle + Sticker (Updated)</title>
<style>
  :root{
    --bg1:#0a0a0a;           /* n·ªÅn t·ªëi 1 */
    --bg2:#1a1a1a;           /* n·ªÅn t·ªëi 2 */
    --text:#ffffff;          /* m√†u ch·ªØ */
    --muted:#cfcfcf;         /* ch·ªØ ph·ª• */
    --card:rgba(255,255,255,0.06);
    --glass:rgba(255,255,255,0.05);
    --border:rgba(255,255,255,0.1);
    --grad2:#7209b7;         /* t√≠m */
    --grad3:#f72585;         /* h·ªìng */
  }
  body.light{
    --bg1:#f3f4f6;
    --bg2:#e5e7eb;
    --text:#111827;
    --muted:#4b5563;
    --card:rgba(0,0,0,0.05);
    --glass:rgba(0,0,0,0.04);
    --border:rgba(0,0,0,0.08);
  }*{box-sizing:border-box} html,body{height:100%} body{ margin:0; color:var(--text); font-family:"Segoe UI", Roboto, Inter, system-ui, Arial, sans-serif; background: linear-gradient(135deg, var(--bg1), var(--bg2)); -webkit-font-smoothing:antialiased; display:flex; flex-direction:column; min-height:100vh; }

.header{position:sticky; top:0; z-index:50; display:flex; align-items:center; gap:12px; padding:14px 16px; border-bottom:1px solid var(--border); background:linear-gradient(90deg, rgba(0,0,0,0.12), rgba(255,255,255,0.02)); backdrop-filter: blur(8px);} .logo{width:64px;height:64px;border-radius:50%;flex:0 0 64px;overflow:hidden;border:3px solid var(--accent);box-shadow:0 6px 30px rgba(247,37,133,0.15);} .logo img{width:100%;height:100%;object-fit:cover;display:block} .hdr-title{display:flex;flex-direction:column} .hdr-title h1{margin:0;font-size:18px;letter-spacing:.5px;text-shadow:0 0 10px rgba(247,37,133,.5)} .hdr-title p{margin:2px 0 0;color:var(--muted);font-size:12px} .hdr-actions{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap} .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:var(--glass);color:var(--text);font-weight:600;cursor:pointer} .btn-gradient{background:linear-gradient(90deg,var(--grad2),var(--grad3));border:none;color:#fff;box-shadow:0 6px 18px rgba(0,0,0,.25)}

.wrap{flex:1; display:flex; padding:16px; gap:16px; width:100%; margin:0} .left{flex:1; display:flex; flex-direction:column; min-height:480px; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.03)); border-radius:14px; padding:14px; backdrop-filter: blur(6px); box-shadow:0 10px 30px rgba(0,0,0,.35)} .chat-window{flex:1; display:flex; flex-direction:column; overflow:hidden; border-radius:12px; background:linear-gradient(180deg, rgba(0,0,0,0.10), rgba(0,0,0,0.05)); padding:12px} .quick{display:flex; gap:8px; padding:8px 0; flex-wrap:wrap} .chip{background:var(--glass); padding:8px 12px; border-radius:20px; color:var(--muted); cursor:pointer; border:1px solid var(--border)} .chip:hover{background:linear-gradient(90deg,#ffffff1a,#ffffff0a); color:var(--text)} .messages{flex:1; overflow:auto; padding:10px; display:flex; flex-direction:column; gap:10px} .bubble{max-width:85%; padding:12px 14px; border-radius:16px; line-height:1.45; word-break:break-word; animation:bounceIn .35s ease} .bubble.user{align-self:flex-end; background:linear-gradient(90deg,var(--grad2),var(--grad3)); box-shadow:0 6px 18px rgba(247,37,133,.15); color:#fff} .bubble.bot{align-self:flex-start; background:var(--card); box-shadow:0 4px 18px rgba(0,0,0,.35)} .bubble .meta{font-size:12px; color:var(--muted); margin-bottom:6px} .sticker{display:block;margin-top:8px;width:120px;height:auto;border-radius:10px;border:2px solid rgba(255,255,255,0.06);box-shadow:0 8px 30px rgba(0,0,0,0.3)} @keyframes bounceIn{0%{opacity:0; transform:translateY(14px) scale(.96)}100%{opacity:1; transform:translateY(0) scale(1)}} .input-row{display:flex; gap:10px; align-items:center; padding-top:10px} .input-row input{flex:1; padding:12px 14px; border-radius:28px; border:1px solid var(--border); background:rgba(255,255,255,0.03); color:var(--text); outline:none; transition:all .25s} .input-row input:focus{border-color:var(--grad2); box-shadow:0 0 16px rgba(114,9,183,.25)} .btn-send{padding:10px 16px; border-radius:28px; border:none; background:linear-gradient(90deg,var(--grad2),var(--grad3)); color:#fff; font-weight:700; cursor:pointer} .music-control{position:fixed; bottom:20px; right:20px; background:var(--card); padding:12px; border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.4); backdrop-filter:blur(10px); display:none; z-index:1000; min-width:250px} .music-control.show{display:block} .music-title{font-size:14px; font-weight:600; color:var(--text); margin-bottom:8px} .music-buttons{display:flex; gap:8px; align-items:center} .music-btn{padding:6px 10px; border:none; border-radius:6px; background:linear-gradient(90deg,var(--grad2),var(--grad3)); color:#fff; font-size:11px; font-weight:700; cursor:pointer} .volume-control{display:flex; align-items:center; gap:8px; margin-top:8px} .volume-slider{flex:1; height:4px; background:rgba(255,255,255,0.25); border-radius:2px} .toast{position:fixed; top:20px; right:20px; background:var(--card); padding:12px 16px; border-radius:10px; color:var(--text); z-index:1100; backdrop-filter:blur(10px); transform:translateX(400px); transition:transform .3s ease} .toast.show{transform:translateX(0)} @media(max-width:900px){ .wrap{padding:10px} .music-control{bottom:10px; right:10px; min-width:220px} } </style>

</head>
<body>
  <div class="header">
    <div class="logo"><img src="https://i.postimg.cc/T3SYQ8zK/Polish-20250822-083928173.png" alt="XMOD"></div>
    <div class="hdr-title">
      <h1>‚ö° XMOD Chat (VIP)</h1>
      <p>Chat h·ªó tr·ª£ mod ‚Äî g√µ l·ªánh ho·∫∑c b·∫•m n√∫t nhanh</p>
    </div>
    <div class="hdr-actions">
      <a class="btn" href="https://modskinaov.github.io/Xmod." target="_blank">Website</a>
      <a class="btn-gradient" href="https://youtube.com/@xmod-b7i" target="_blank">YouTube</a>
      <button id="toggleTheme" class="btn">üåì Theme</button>
    </div>
  </div>  <div class="music-control" id="musicControl">
    <div class="music-title" id="musicTitle">üéµ Ch∆∞a c√≥ nh·∫°c</div>
    <div class="music-buttons">
      <button class="music-btn" id="playBtn">‚ñ∂Ô∏è Play</button>
      <button class="music-btn" id="pauseBtn">‚è∏Ô∏è Pause</button>
      <button class="music-btn" id="stopBtn">‚èπÔ∏è Stop</button>
    </div>
    <div class="volume-control">
      <span>üîä</span>
      <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50">
    </div>
  </div>  <div class="wrap">
    <div class="left">
      <div class="chat-window">
        <div class="quick" id="quickCommands">
          <div class="chip" data-cmd="help">help</div>
          <div class="chip" data-cmd="laymod">laymod</div>
          <div class="chip" data-cmd="allmods">allmods</div>
          <div class="chip" data-cmd="g·ª£i √Ω skin">g·ª£i √Ω skin</div>
          <div class="chip" data-cmd="update">update</div>
          <div class="chip" data-cmd="donate">donate</div>
          <div class="chip" data-cmd="ch√©m gi√≥">ch√©m gi√≥</div>
          <div class="chip" data-cmd="ch·ªçn nh·∫°c">ch·ªçn nh·∫°c</div>
          <div class="chip" data-cmd="x√≥a l·ªãch s·ª≠">x√≥a l·ªãch s·ª≠</div>
          <div class="chip" data-cmd="th·ªëng k√™">th·ªëng k√™</div>
          <div class="chip" data-cmd="random mod">random mod</div>
          <div class="chip" data-cmd="trivia">trivia</div>
          <div class="chip" data-cmd="guide">guide</div>
          <div class="chip" data-cmd="lucky draw">lucky draw</div>
        </div>
    <div class="messages" id="messages"></div>
    <div class="input-row">
      <input id="inp" placeholder="Nh·∫≠p l·ªánh ho·∫∑c chat... (g√µ 'help' ƒë·ªÉ xem)"/>
      <button class="btn-send" id="sendBtn">G·ª≠i</button>
    </div>
  </div>
</div>
  </div>
  <audio id="backgroundMusic" loop></audio><script>
/***********************************************
 * XMOD v2 ‚Äì UPDATED: m·ªói l·ªánh c√≥ sticker ri√™ng
 * - M√¨nh ch·ªâ s·ª≠a ch·ªó li√™n quan t·ªõi stickerKey v√† th√™m
 *   ch√∫ th√≠ch ti·∫øng Vi·ªát r√µ r√†ng (kh√¥ng thay ƒë·ªïi logic).
 * - Thay URL sticker theo √Ω b·∫°n trong ph·∫ßn STICKERS.
 ***********************************************/

/* =============================
   0) D·ªÆ LI·ªÜU ‚Äì CH·ªà S·ª¨A PH·∫¶N N√ÄY n·∫øu c·∫ßn
   - STICKERS: map key -> link ·∫£nh sticker
   - Thay c√°c URL b·∫±ng link th·ª±c t·∫ø c·ªßa b·∫°n
   ============================= */
const MUSIC_LIST = [
  { id:"music1", title:"legendary", url:"https://www.dropbox.com/scl/fi/003fj25b92y8jio117ip9/Legends-Never-Die-ft.-Against-The-Current-2017.mp3?rlkey=s3qb0nb4ypbjj4w8kqrzq1udy&dl=1" },
  { id:"music2", title:"ƒëang update", url:"THAY_LINK_NHAC_2.mp3" },
  { id:"music3", title:"ƒëang update", url:"THAY_LINK_NHAC_3.mp3" }
];

const MODS = [
  { id:"m1", title:"Nakroth Gi·∫£ Kim Thu·∫≠t S∆∞", desc:"Hi·ªáu ·ª©ng s√°ng t·∫°o m·ªõi l·∫°", thumb:"https://i.postimg.cc/L5K9dVrK/53202.jpg", link:"https://www.mediafire.com/file/lahx0a7mbghy3wl/NAKROTH_GKTS-XMOD.zip/file" },
  { id:"m2", title:"Alchemist Blade", desc:"Hi·ªáu ·ª©ng s√°ng t·∫°o m·ªõi l·∫°", thumb:"https://i.postimg.cc/L5K9dVrK/53202.jpg", link:"https://www.mediafire.com/file/bpgspvstitdpk4o/Alchemist_Blade.7z/file" },
  { id:"m3", title:"Resources 28.8 Pack", desc:"Full resources c·∫≠p nh·∫≠t 28.8", thumb:"https://i.postimg.cc/J4FFHy5f/folder-la-gi.jpg", link:"https://www.mediafire.com/file/oi7bhkm1fqbb1p8/Resources_28.8.zip/file" }
];

// ==== STICKERS: s·ª≠a link ·∫£nh theo √Ω b·∫°n ====
// GHI CH√ö: m·ªói key ƒë·∫°i di·ªán cho 1 l·ªánh / t√¨nh hu·ªëng.
// B·∫°n n√™n ƒë·ªïi t·ª´ng URL th√†nh ·∫£nh ri√™ng cho t·ª´ng l·ªánh ƒë·ªÉ ƒë·∫£m b·∫£o "m·ªói l·ªánh 1 sticker".
const STICKERS = {
  default: "https://i.postimg.cc/xTM2bBXL/2024-4-25-638496713669047688-duolingo-meme-27.webp",
  help: "https://i.postimg.cc/5tkjyDr8/Kh-ng-C-Ti-u-3-20250828125708.png",
  laymod: "https://i.postimg.cc/TYqwgKSd/Kh-ng-C-Ti-u-5-20250828130406.png",
  allmods: "https://i.postimg.cc/GhR6fK3C/Polish-20250828-142746287.png",
  suggestion: "https://i.postimg.cc/hPg4DSGH/Kh-ng-C-Ti-u-6-20250828130645.png",
  donate: "https://i.postimg.cc/dVNJjr9Y/Kh-ng-C-Ti-u-7-20250828131030.png",
  music: "https://i.postimg.cc/RVM9rXsm/lich-su-duolingo-meme-xuat-hien.jpg",
  cleared: "https://i.postimg.cc/xTM2bBXL/2024-4-25-638496713669047688-duolingo-meme-27.webp",
  missYou: "https://i.postimg.cc/xC2jXYRJ/Polish-20250828-133602172.jpg",
  unknown: "https://i.postimg.cc/QMLhzsv4/Kh-ng-C-Ti-u-13-20250828132014.png",
  aiFallback: "https://i.postimg.cc/QMLhzsv4/Kh-ng-C-Ti-u-13-20250828132014.png",
  copy: "https://i.postimg.cc/xTM2bBXL/2024-4-25-638496713669047688-duolingo-meme-27.webp",
  stats: "https://i.postimg.cc/xTM2bBXL/2024-4-25-638496713669047688-duolingo-meme-27.webp",
  random: "https://i.postimg.cc/qvPqfWNR/duolingo-language-lessons.jpg",
  trivia: "https://i.postimg.cc/qvPqfWNR/duolingo-language-lessons.jpg",
  guide: "https://i.postimg.cc/5tkjyDr8/Kh-ng-C-Ti-u-3-20250828125708.png",
  chemgio: "https://i.postimg.cc/xT7THByR/Kh-ng-C-Ti-u-9-20250828131456.png",
  lucky: "https://i.postimg.cc/qvPqfWNR/duolingo-language-lessons.jpg",
  request: "https://i.postimg.cc/GhR6fK3C/Polish-20250828-142746287.png",
  update: "https://i.postimg.cc/tJkkwhDq/cover-at-duolingo-humans-and-ai-work-together-to-create-a-high-quality-learning-experience-383244722.png",
  youtube: "https://i.postimg.cc/GmFtCqGx/Polish-20250822-083928173.png",
  search: "https://i.postimg.cc/d1pZ1D12/Kh-ng-C-Ti-u-3-20250828125555.png",
  confirmDelete: "https://i.postimg.cc/7PN8NSxW/Kh-ng-C-Ti-u-12-20250828131800.png",
  aiError: "https://i.postimg.cc/xTM2bBXL/2024-4-25-638496713669047688-duolingo-meme-27.webp"
};

/* =============================
   1) TI·ªÜN √çCH (UTILITIES)
   - C√°c h√†m hi·ªÉn th·ªã, l∆∞u l·ªãch s·ª≠, scroll... c√≥ ch√∫ th√≠ch ti·∫øng Vi·ªát
   ============================= */
const messagesEl = document.getElementById('messages');
const STORAGE_KEY = 'xmod_chat_history_v2';
const LAST_VISIT_KEY = 'xmod_last_visit_v2';
const MISSYOU_THRESHOLD_MS = 1000 * 60 * 60 * 24 * 7; // 7 ng√†y

function showToast(message, duration = 2500){
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = message;
  document.body.appendChild(t);
  requestAnimationFrame(()=> t.classList.add('show'));
  setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=> t.remove(), 300); }, duration);
}

function escapeHtml(str){
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

function scrollToBottom(){ setTimeout(()=> messagesEl.scrollTop = messagesEl.scrollHeight, 60); }

/**
 * addBotMsg(html, meta, stickerKey)
 * - html: n·ªôi dung HTML ƒë√£ escape n·∫øu c·∫ßn
 * - meta: text ph·ª• (v√≠ d·ª•: "Bot ƒëang so·∫°n...")
 * - stickerKey: key trong STICKERS (b·∫Øt bu·ªôc ƒë·ªÉ m·ªói l·ªánh c√≥ sticker ri√™ng)
 */
function addBotMsg(html, meta, stickerKey){
  // L·∫•y URL sticker t·ª´ STICKERS theo key; n·∫øu kh√¥ng t√¨m th·∫•y -> d√πng default
  const stickerUrl = stickerKey && STICKERS[stickerKey] ? STICKERS[stickerKey] : (STICKERS.default || '');
  const obj = { sender:'bot', html, meta: meta || '', sticker: stickerUrl || '' , timestamp: Date.now() };
  appendMessageToDom(obj);
  saveToHistory(obj);
}

/**
 * appendMessageToDom(item)
 * - item: {sender, html, meta, sticker}
 * - Hi·ªÉn th·ªã tin nh·∫Øn v√† sticker (n·∫øu c√≥)
 */
function appendMessageToDom(item){
  const div = document.createElement('div');
  div.className = 'bubble ' + (item.sender === 'user' ? 'user' : 'bot');
  let contentHtml = item.meta ? `<div class="meta">${item.meta}</div>${item.html}` : item.html;
  if(item.sticker){
    // Ch√∫ th√≠ch: th·∫ª ·∫£nh sticker s·∫Ω hi·ªÉn th·ªã d∆∞·ªõi n·ªôi dung bot. B·∫°n c√≥ th·ªÉ thay class .sticker n·∫øu mu·ªën k√≠ch th∆∞·ªõc kh√°c
    contentHtml += `<img src="${item.sticker}" alt="sticker" class="sticker">`;
  }
  div.innerHTML = contentHtml;
  messagesEl.appendChild(div);
  scrollToBottom();
}

/* =============================
   2) L·ªäCH S·ª¨ + TH·ªêNG K√ä
   ============================= */
let HISTORY = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
HISTORY.forEach(appendMessageToDom);
scrollToBottom();

let chatStats = { totalMessages: 0, commandsUsed: {}, startTime: Date.now() };
const savedStats = localStorage.getItem('xmod_chat_stats');
if(savedStats) chatStats = JSON.parse(savedStats);
function saveStats(){ localStorage.setItem('xmod_chat_stats', JSON.stringify(chatStats)); }

function saveToHistory(obj){
  HISTORY.push(obj); if(HISTORY.length>200) HISTORY.shift();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(HISTORY));
}

function addUserMsg(text){
  const obj = {sender:'user', html: escapeHtml(text), timestamp: Date.now()};
  appendMessageToDom(obj); saveToHistory(obj); chatStats.totalMessages++; saveStats();
}

function clearChatHistory(){
  localStorage.removeItem(STORAGE_KEY); HISTORY = []; messagesEl.innerHTML='';
  addBotMsg('üóëÔ∏è ƒê√£ x√≥a to√†n b·ªô l·ªãch s·ª≠ chat!', '', 'cleared');
}

/* =============================
   3) MUSIC CONTROLS
   ============================= */
const audioEl = document.getElementById('backgroundMusic');
const musicControl = document.getElementById('musicControl');
const musicTitle = document.getElementById('musicTitle');
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const stopBtn = document.getElementById('stopBtn');
const volumeSlider = document.getElementById('volumeSlider');
let currentMusicIndex = -1; audioEl.volume = 0.5;

playBtn.addEventListener('click', ()=>{
  if(audioEl.src){ audioEl.play().catch(()=>{}); addBotMsg('üéµ ƒê√£ ph√°t nh·∫°c', '', 'music'); }
  else addBotMsg('‚ö†Ô∏è Ch∆∞a ch·ªçn nh·∫°c. G√µ <b>ch·ªçn nh·∫°c</b> ƒë·ªÉ ch·ªçn.', '', 'music');
});
 pauseBtn.addEventListener('click', ()=>{ audioEl.pause(); addBotMsg('‚è∏Ô∏è ƒê√£ t·∫°m d·ª´ng nh·∫°c', '', 'music'); });
 stopBtn.addEventListener('click', ()=>{ audioEl.pause(); audioEl.currentTime=0; addBotMsg('‚èπÔ∏è ƒê√£ d·ª´ng nh·∫°c', '', 'music'); });
 volumeSlider.addEventListener('input', ()=> audioEl.volume = volumeSlider.value/100 );

function selectMusic(index){
  if(index>=0 && index<MUSIC_LIST.length){
    currentMusicIndex = index; const m = MUSIC_LIST[index]; audioEl.src = m.url;
    musicTitle.textContent = `üéµ ${m.title}`; musicControl.classList.add('show');
    addBotMsg(`üéµ ƒê√£ ch·ªçn nh·∫°c: <b>${m.title}</b><br>B·∫•m Play ƒë·ªÉ ph√°t.`, '', 'music');
  }
}

/* =============================
   4) RENDER MOD CARD (d√πng khi hi·ªÉn th·ªã mod trong chat)
   - Ch√∫ th√≠ch ti·∫øng Vi·ªát k√®m theo h√†m
   ============================= */
function renderModCardHtml(m){
  return `
    <div style="display:flex;gap:10px;align-items:center;">
      <div style="width:86px;height:64px;flex:0 0 86px;border-radius:8px;overflow:hidden;border:2px solid var(--border)">
        <img src="${m.thumb}" style="width:100%;height:100%;object-fit:cover" alt="${m.title}">
      </div>
      <div style="flex:1">
        <div style="font-weight:700">${m.title}</div>
        <div style="color:var(--muted);font-size:13px;margin-top:6px">${m.desc}</div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <a href="${m.link}" target="_blank" style="padding:8px 12px;border-radius:8px;background:linear-gradient(90deg,var(--grad2),var(--grad3));color:#fff;font-weight:700;text-decoration:none">T·∫£i</a>
          <button onclick="copyLink('${m.link}')" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--glass);color:var(--text);cursor:pointer">Sao ch√©p link</button>
        </div>
      </div>
    </div>`;
}
function copyLink(url){
  navigator.clipboard?.writeText(url).then(()=> addBotMsg('Link ƒë√£ sao ch√©p ‚úÖ', '', 'copy'))
  .catch(()=> addBotMsg(`Kh√¥ng th·ªÉ sao ch√©p. M·ªü link ƒë·ªÉ t·∫£i: <a href='${url}' target='_blank'>M·ªü link</a>`, '', 'copy'));
}

/* =============================
   5) X·ª¨ L√ù L·ªÜNH (COMMAND HANDLER)
   - M·ªói l·ªánh gi·ªù truy·ªÅn stickerKey ri√™ng
   - V·∫´n gi·ªØ nguy√™n logic ban ƒë·∫ßu
   ============================= */
function trackCommand(cmd){ chatStats.commandsUsed[cmd] = (chatStats.commandsUsed[cmd]||0)+1; saveStats(); }

function handleCommand(input){
  const cmd = input.trim().toLowerCase();
  trackCommand(cmd);

  if(cmd === 'help'){
    addBotMsg(`
      <b>Danh s√°ch l·ªánh:</b><br>
      - <b>laymod</b> : Hi·ªán to√†n b·ªô mod trong chat<br>
      - <b>allmods</b> : (gi·ªëng laymod) li·ªát k√™ t·∫•t c·∫£ mod<br>
      - <b>g·ª£i √Ω skin</b> : G·ª£i √Ω random 1 mod<br>
      - <b>donate</b> : Hi·ªÉn th·ªã QR donate<br>
      - <b>update</b> : Th√¥ng b√°o c·∫≠p nh·∫≠t m·ªõi<br>
      - <b>youtube</b> : Link k√™nh XMOD<br>
      - <b>ch√©m gi√≥</b> : Bot ch√©m gi√≥ vui v·∫ª<br>
      - <b>ch·ªçn nh·∫°c</b> : Danh s√°ch nh·∫°c n·ªÅn üéµ<br>
      - <b>x√≥a l·ªãch s·ª≠</b> : X√≥a to√†n b·ªô l·ªãch s·ª≠ chat üóëÔ∏è<br>
      - <b>th·ªëng k√™</b> : Th·ªëng k√™ s·ª≠ d·ª•ng üì†<br>
      - <b>search &lt;t·ª´ kh√≥a&gt;</b> : T√¨m mod theo t√™n/m√¥ t·∫£<br>
      - <b>request &lt;t√™n mod&gt;</b> : G·ª≠i y√™u c·∫ßu mod
    `, '', 'help');
    return;
  }

  if(cmd === 'th·ªëng k√™' || cmd === 'stats'){
    const uptime = Math.floor((Date.now()-chatStats.startTime)/1000/60);
    const top = Object.entries(chatStats.commandsUsed).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([c,n])=>`‚Ä¢ ${c}: ${n} l·∫ßn`).join('<br>') || '‚Ä¢ Ch∆∞a c√≥ d·ªØ li·ªáu';
    addBotMsg(`<b>üìä Th·ªëng k√™:</b><br>üí¨ Tin nh·∫Øn: <b>${chatStats.totalMessages}</b><br>‚è∞ Online: <b>${uptime} ph√∫t</b><br>üî• L·ªánh nhi·ªÅu nh·∫•t:<br>${top}`, '', 'stats');
    return;
  }

  if(cmd === 'laymod' || cmd === 'allmods'){
    let html = `<b>üì¶ Dan s√°ch mod hi·ªán c√≥ (${MODS.length}):</b><br>`;
    MODS.forEach(m=> html += renderModCardHtml(m)+"<br>");
    addBotMsg(html, '', 'laymod');
    return;
  }

  if(cmd === 'g·ª£i √Ω skin' || cmd === 'goi y skin' || cmd === 'goiyskin'){
    const m = MODS[Math.floor(Math.random()*MODS.length)];
    addBotMsg(`ü§î G·ª£i √Ω: <b>${m.title}</b><br>${renderModCardHtml(m)}`, '', 'suggestion');
    return;
  }

  if(cmd === 'donate'){
    addBotMsg(`
      <b>üíù ·ª¶ng h·ªô XMOD</b><br>
      <img src="https://i.postimg.cc/YqG9JCtp/i-Pay-Fri-Aug-22-10-47-44-GMT-07-00-2025.jpg" alt="QR" style="width:180px;border-radius:8px;margin-top:8px"><br>
      VietinBank: <b>xxxxxxx</b><br>Ch·ªß TK: <b>M·∫π T√¥i</b>
    `, '', 'donate');
    return;
  }

  if(cmd === 'random mod' || cmd === 'random'){
    addBotMsg('üé≤ ƒêang l·∫Øc x√∫c x·∫Øc...', '', 'random');
    setTimeout(()=>{ const m = MODS[Math.floor(Math.random()*MODS.length)]; addBotMsg(`üéØ May m·∫Øn c·ªßa b·∫°n: <b>${m.title}</b><br>${renderModCardHtml(m)}`, '', 'random'); }, 1200);
    return;
  }

  if(cmd === 'trivia'){
    const qs = [
      'Nakroth c√≥ bao nhi√™u skill? Tr·∫£ l·ªùi: 4 skill (3 th∆∞·ªùng + 1 n·ªôi t·∫°i)',
      'T∆∞·ªõng n√†o ƒë∆∞·ª£c g·ªçi l√† Th·∫ßn R·ª´ng? Tr·∫£ l·ªùi: Nakroth',
      'Map Li√™n Qu√¢n c√≥ bao nhi√™u l√†n? Tr·∫£ l·ªùi: 3 l√†n'
    ];
    addBotMsg(`üß† C√¢u h·ªèi: ${qs[Math.floor(Math.random()*qs.length)]}`, '', 'trivia');
    return;
  }

  if(cmd === 'guide'){
    addBotMsg(`
      <b>üìã H∆∞·ªõng d·∫´n c√†i mod:</b><br>
      1. T·∫£i file mod v·ªÅ m√°y<br>
      2. Gi·∫£i n√©n b·∫±ng ZArchiver/MT<br>
      3. Sao ch√©p v√†o th∆∞ m·ª•c game<br>
      4. Kh·ªüi ƒë·ªông game v√† th∆∞·ªüng th·ª©c!<br>
      <i>‚ö†Ô∏è Nh·ªõ backup file g·ªëc tr∆∞·ªõc khi c√†i</i>
    `, '', 'guide');
    return;
  }

  if(cmd==="ch√©m gi√≥" || cmd==="chem gio"){
    const jokes = [
      "‚ö° Nakroth m√† ƒÉn s√©t Toro th√¨ g√°nh team lu√¥n!",
      "M√¨nh l√† XMOD GPT, chuy√™n gia mod ·∫£o nh∆∞ng th·ª±c t·∫ø th√¨... m√¨nh c≈©ng c·∫ßn coffee ‚òï",
      "B·∫°n mod nhi·ªÅu th√¨ ƒë·ª´ng qu√™n donate ƒë·ªÉ m√¨nh kh·ªèi ƒÉn m√¨ g√≥i üòÜ",
      "üéµ Nghe nh·∫°c trong l√∫c mod s·∫Ω th·∫•y ƒë√£ h∆°n ƒë·∫•y!",
      "Chat v·ªõi bot m√† vui nh∆∞ chat v·ªõi crush v·∫≠y üòé"
    ];
    addBotMsg(jokes[Math.floor(Math.random()*jokes.length)], '', 'chemgio');
    return;
  }

  if(cmd.startsWith('search ') || cmd.startsWith('tim ')){
    const query = cmd.replace('search ','').replace('tim ','').trim();
    const results = MODS.filter(m=> m.title.toLowerCase().includes(query) || m.desc.toLowerCase().includes(query));
    if(results.length){
      let html = `üîç T√¨m th·∫•y ${results.length} mod:<br>`;
      results.forEach(m=> html += renderModCardHtml(m)+"<br>");
      addBotMsg(html, '', 'search');
    }else addBotMsg(`‚ùå Kh√¥ng t√¨m th·∫•y mod v·ªõi t·ª´ kh√≥a: <b>${escapeHtml(query)}</b>`, '', 'search');
    return;
  }

  if(cmd === 'lucky' || cmd === 'lucky draw'){
    const prizes = ['üéÅ B·∫°n tr√∫ng: Gi·∫£i nh·∫•t (‚Ä¶ƒë√πa th√¥i üòÜ)', 'üèÜ B·∫°n tr√∫ng: Gi·∫£i nh√¨!', 'üíé B·∫°n tr√∫ng: Gi·∫£i ba!', 'üéØ B·∫°n tr√∫ng: Gi·∫£i t∆∞!'];
    addBotMsg('üé∞ ƒêang quay s·ªë...', '', 'lucky');
    setTimeout(()=> addBotMsg(prizes[Math.floor(Math.random()*prizes.length)], '', 'lucky'), 1500);
    return;
  }

  if(cmd.startsWith('request ')){
    const modName = cmd.slice(8).trim();
    addBotMsg(`üìù ƒê√£ ghi nh·∫≠n y√™u c·∫ßu mod: <b>${escapeHtml(modName)}</b><br>Admin s·∫Ω xem x√©t v√† c·∫≠p nh·∫≠t sau!`, '', 'request');
    return;
  }

  if(cmd === 'update'){
    addBotMsg(`üÜï C·∫≠p nh·∫≠t: ƒê√£ th√™m mod <b>${MODS[0]?.title || 'm·ªõi'}</b> v√† pack Resources 28.8.`, '', 'update');
    return;
  }

  if(cmd === 'youtube'){
    addBotMsg(`üé¨ K√™nh YouTube: <a href="https://youtube.com/@xmod-b7i" target="_blank">XMOD Official</a>`, '', 'youtube');
    return;
  }

  if(cmd === 'ch·ªçn nh·∫°c' || cmd === 'chon nhac' || cmd === 'music'){
    let html = `<b>üéµ Danh s√°ch nh·∫°c n·ªÅn:</b><br>G√µ s·ªë ƒë·ªÉ ch·ªçn (VD: <b>1</b>)<br><br>`;
    MUSIC_LIST.forEach((m,i)=> html += `<b>${i+1}</b>. ${m.title}<br>`);
    html += `<br><i>Sau khi ch·ªçn, d√πng khung ƒëi·ªÅu khi·ªÉn g√≥c d∆∞·ªõi ƒë·ªÉ Play/Pause.</i>`;
    addBotMsg(html, '', 'music');
    return;
  }

  const musicNumber = parseInt(cmd);
  if(!isNaN(musicNumber) && musicNumber>=1 && musicNumber<=MUSIC_LIST.length){ selectMusic(musicNumber-1); return; }

  if(cmd === 'x√≥a l·ªãch s·ª≠' || cmd === 'xoa lich su' || cmd === 'clear' || cmd === 'x√≥a chat'){
    addBotMsg(`<b>‚ö†Ô∏è X√°c nh·∫≠n x√≥a l·ªãch s·ª≠?</b><br>G√µ <b>"x√°c nh·∫≠n x√≥a"</b> ƒë·ªÉ x√≥a to√†n b·ªô l·ªãch s·ª≠ chat.<br><i>H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</i>`, '', 'confirmDelete');
    return;
  }
  if(cmd === 'x√°c nh·∫≠n x√≥a' || cmd === 'xac nhan xoa' || cmd === 'confirm delete'){ clearChatHistory(); return; }

  // N·∫øu kh√¥ng tr√πng l·ªánh n√†o ·ªü tr√™n: hi·ªÉn th·ªã th√¥ng b√°o "kh√¥ng hi·ªÉu" + sticker, r·ªìi g·ªçi AI fallback
  addBotMsg(`‚ùì M√¨nh ch∆∞a hi·ªÉu l·ªánh "<b>${escapeHtml(input)}</b>". M√¨nh th·ª≠ tr·∫£ l·ªùi b·∫±ng AI nh√©...`, '', 'unknown');
  callOpenAI(cmd);
}

/* =============================
   6) INPUT & CHIPS
   ============================= */
const inp = document.getElementById('inp');
const sendBtn = document.getElementById('sendBtn');
sendBtn.addEventListener('click', onSend);
inp.addEventListener('keypress', e=>{ if(e.key==='Enter') onSend(); });

function onSend(){
  const text = inp.value.trim(); if(!text) return; addUserMsg(text); inp.value='';
  const typing = document.createElement('div'); typing.className = 'bubble bot'; typing.innerHTML = `<div class="meta">Bot ƒëang so·∫°n...</div>`; messagesEl.appendChild(typing); scrollToBottom();
  setTimeout(()=>{ typing.remove(); handleCommand(text); }, 500 + Math.random()*700);
}

document.querySelectorAll('.chip').forEach(el=> el.addEventListener('click', ()=>{ inp.value = el.getAttribute('data-cmd'); inp.focus(); }));

/* =============================
   7) THEME TOGGLE (üåì)
   - L∆∞u ch·∫ø ƒë·ªô v√†o localStorage
   ============================= */
const themeBtn = document.getElementById('toggleTheme');
(function(){
  const saved = localStorage.getItem('xmod_theme');
  if(saved === 'light') document.body.classList.add('light');
})();

themeBtn.addEventListener('click', ()=>{
  document.body.classList.toggle('light');
  const mode = document.body.classList.contains('light') ? 'light' : 'dark';
  localStorage.setItem('xmod_theme', mode);
  showToast(mode==='light' ? 'üåû Giao di·ªán s√°ng' : 'üåô Giao di·ªán t·ªëi');
});

/* =============================
   8) INTRO + "T√¥i nh·ªõ b·∫°n qu√°" CHECK
   - N·∫øu l√¢u kh√¥ng v√†o (theo MISSYOU_THRESHOLD_MS), hi·ªán 1 message ƒë·∫∑c bi·ªát k√®m sticker
   ============================= */
(function checkLastVisitAndIntro(){
  const last = parseInt(localStorage.getItem(LAST_VISIT_KEY) || '0', 10);
  const now = Date.now();
  if(!HISTORY.length){
    addBotMsg("Xin ch√†o üëã! M√¨nh l√† <b>XMOD Chat</b> ‚Äî g√µ <b>help</b> ƒë·ªÉ xem l·ªánh.\n\nüéµ <i>Th·ª≠ l·ªánh 'ch·ªçn nh·∫°c' ƒë·ªÉ nghe nh·∫°c n·ªÅn nh√©!</i>", '', 'help');
  }
  if(!last || (now - last) > MISSYOU_THRESHOLD_MS){
    addBotMsg(`<b>T√¥i nh·ªõ b·∫°n qu√°! üíñ</b><br>L√¢u r·ªìi b·∫°n ch∆∞a gh√©. Ch√†o m·ª´ng b·∫°n ƒë√£ tr·ªü l·∫°i!`, '', 'missYou');
  }
  localStorage.setItem(LAST_VISIT_KEY, String(now));
})();

/* =============================
   9) OPENAI FALLBACK
   - L∆∞u √Ω: KH√îNG ƒë·ªÉ API key ·ªü client cho production
   - Th√¥ng b√°o l·ªói c√≥ sticker ri√™ng
   ============================= */
async function callOpenAI(userText){
  addBotMsg('‚è≥ ƒêang h·ªèi AI, ch·ªù ch√∫t nh√©...', '', 'aiFallback');
  try{
    const res = await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer YOUR_API_KEY_HERE' },
      body: JSON.stringify({ model:'gpt-3.5-turbo', messages:[ {role:'system', content:'B·∫°n l√† tr·ª£ l√Ω XMOD.'}, {role:'user', content:userText} ], max_tokens:500, temperature:0.8 })
    });
    const data = await res.json();
    const reply = data.choices?.[0]?.message?.content || '‚ùå AI kh√¥ng tr·∫£ l·ªùi ƒë∆∞·ª£c. ƒë√¢y ch·ªâ l√† chatbot x·ª≠ l√Ω l·ªánh ƒë∆∞·ª£c l·∫≠p tr√¨nh s·∫µn th√¥i n√™n ƒë·ª´ng soi m·ªëi n·∫øu mu·ªën nh∆∞ chatgbt, Gemini,grock.... th√¨ donate 1 tri·ªáu admin t√¨m c√°ch l√†m li·ªÅn!.';
    addBotMsg(escapeHtml(reply).replace(/\n/g,'<br>'), '', 'aiFallback');
  }catch(e){ console.error(e); addBotMsg('‚ö†Ô∏è L·ªói khi g·ªçi OpenAI. ki·ªÉm tra api key ho·∫∑c m·∫°ng(ƒê√©o c·∫ßn ki·ªÉm tra g√¨ c·∫£ v√¨ t·∫°o ƒë√©o ƒë·ªÉ key!)', '', 'aiError'); }
}

// expose for console debugging
window.XMOD = { MODS, MUSIC_LIST, addBotMsg, addUserMsg, copyLink, selectMusic };
</script>
</body>
</html>
